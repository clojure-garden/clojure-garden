version: "3.9"
services:

  backend-postgres:
    image: postgres:13-alpine
    container_name: "clojure-garden-backend-postgres"
    hostname: backend-postgres
    ports:
      - "${BACKEND_PG_PORT}:5432"
    environment:
      POSTGRES_DB: ${BACKEND_PG_DATABASE_NAME}
      POSTGRES_USER: ${BACKEND_PG_USER}
      POSTGRES_PASSWORD: ${BACKEND_PG_PASSWORD}
      PGDATA: /var/lib/postgresql/data
    networks:
      - metabase-net
      - backend-net
    volumes:
      - "./${BACKEND_PG_DATA}:/var/lib/postgresql/data"


  metabase:
    image: metabase/metabase:v0.41.2
    container_name: "clojure-garden-metabase"
    hostname: metabase
    ports:
      - "${METABASE_PORT}:3000"
    environment:
      MB_DB_TYPE: postgres
      MB_DB_DBNAME: ${METABASE_PG_DATABASE_NAME}
      MB_DB_PORT: 5432
      MB_DB_USER: ${METABASE_PG_USER}
      MB_DB_PASS: ${METABASE_PG_PASSWORD}
      MB_DB_HOST: metabase-postgres
    networks:
      - metabase-net
    depends_on:
      - metabase-postgres
    volumes:
      - /dev/urandom:/dev/random:ro


  metabase-postgres:
    image: postgres:13-alpine
    container_name: "clojure-garden-metabase-postgres"
    hostname: metabase-postgres
    ports:
      - "${METABASE_PG_PORT}:5432"
    environment:
      POSTGRES_DB: ${METABASE_PG_DATABASE_NAME}
      POSTGRES_USER: ${METABASE_PG_USER}
      POSTGRES_PASSWORD: ${METABASE_PG_PASSWORD}
      PGDATA: /var/lib/postgresql/data
    networks:
      - metabase-net
    volumes:
      - "./${METABASE_PG_DATA}:/var/lib/postgresql/data"


networks:
  metabase-net:
    driver: bridge
  backend-net:
    driver: bridge
